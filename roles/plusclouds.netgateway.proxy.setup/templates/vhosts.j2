upstream proxy-{{ application }} {
{% for host in groups['web_servers']%}
     server {{ hostvars[host].ip_addr }}:{{hostvars[host].port}} max_fails={{ max_fails }} fail_timeout={{ fail_timeout }}s;
{% endfor %}
}

server {
     listen         80;
     server_name    _;

     location / {
          proxy_pass http://proxy-{{ application }};
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
     }
}
